<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Clipper Debug — Log Viewer</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#071022;color:#e6eef8;padding:14px}
  .wrap{max-width:980px;margin:0 auto}
  h1{font-size:18px;margin:0 0 8px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  input[type=file], input[type=text]{padding:8px;border-radius:6px;border:none;background:#061224;color:#e6eef8}
  button{padding:8px 12px;border-radius:8px;border:none;background:#0b74de;color:white;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .note{color:#9fb6d9;margin:8px 0;font-size:13px}
  .panels{display:flex;gap:12px}
  .panel{flex:1;background:#061224;padding:8px;border-radius:8px;min-height:220px;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
  .panel h3{margin:0 0 6px;font-size:14px;color:#cfe9ff}
  .log{font-family:monospace;font-size:12px;white-space:pre-wrap;color:#dfeffd}
  .err{color:#ffb4b4}
  .diag{margin-top:8px;padding:8px;background:#071225;border-radius:6px;color:#bcd6ff;font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Clipper — Debug &amp; Log Viewer</h1>
    <p class="note">Halaman ini akan menampilkan semua console log &amp; log ffmpeg.wasm. Tekan <strong>Load FFmpeg</strong> lalu <strong>Proses</strong>.</p>

    <div class="controls">
      <input id="file" type="file" accept="video/*" />
      <button id="btnLoad">Load FFmpeg</button>
      <button id="btnRun">Proses</button>
      <button id="btnDiag" class="ghost">Show Diagnostics</button>
      <button id="btnClear" class="ghost">Clear Log</button>
    </div>

    <div class="panels" style="margin-bottom:12px">
      <div class="panel">
        <h3>Console &amp; App Log</h3>
        <div id="consoleLog" class="log"></div>
      </div>

      <div class="panel">
        <h3>ffmpeg.wasm Log</h3>
        <div id="ffLog" class="log"></div>
      </div>
    </div>

    <div class="panel" style="min-height:120px">
      <h3>Diagnostics &amp; Suggestions</h3>
      <div id="diagArea" class="diag">
        Tekan <strong>Show Diagnostics</strong> untuk melihat saran perbaikan (CORS, server lokal, Termux).
      </div>
    </div>
  </div>

<script type="module">
import { createFFmpeg, fetchFile } from "https://unpkg.com/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js";
const ffmpeg = createFFmpeg({ log: false });

const consoleLog = document.getElementById('consoleLog');
const ffLog = document.getElementById('ffLog');
const diagArea = document.getElementById('diagArea');

function appendConsole(msg, type='log') {
  const el = document.createElement('div');
  el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  if (type === 'error') el.classList.add('err');
  consoleLog.appendChild(el);
  consoleLog.scrollTop = consoleLog.scrollHeight;
}

(function () {
  const origLog = console.log;
  const origError = console.error;
  console.log = function(...args) {
    origLog.apply(console, args);
    appendConsole(args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' '), 'log');
  };
  console.error = function(...args) {
    origError.apply(console, args);
    appendConsole(args.map(a => (typeof a === 'object' ? JSON.stringify(a) : String(a))).join(' '), 'error');
  };
})();

window.addEventListener('error', (ev) => { console.error('Window error:', ev.message || ev); });
window.addEventListener('unhandledrejection', (ev) => { console.error('Unhandled promise rejection:', ev.reason || ev); });

ffmpeg.setLogger(({ type, message }) => {
  if (message && message.length) {
    const msg = `[${type}] ${message}`;
    const el = document.createElement('div');
    el.textContent = msg;
    ffLog.appendChild(el);
    ffLog.scrollTop = ffLog.scrollHeight;
  }
});
ffmpeg.setProgress(({ ratio }) => {
  const pct = Math.round(ratio * 100);
  appendConsole(`ffmpeg progress: ${pct}%`);
});

async function runDiagnostics() {
  const info = [];
  info.push(`Page origin: ${location.origin}`);
  info.push(`Page protocol: ${location.protocol}`);
  info.push(`User agent: ${navigator.userAgent}`);
  if (location.protocol === 'file:') {
    info.push('⚠️ Halaman dibuka via file:// — banyak browser memblokir fetch/WASM. Disarankan buka lewat HTTP lokal (Termux).');
  } else {
    info.push('Halaman via HTTP(S) — CDN harus bisa diakses.');
  }
  appendConsole('Menguji koneksi ke CDN ffmpeg.wasm ...');
  try {
    const r = await fetch('https://unpkg.com/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js', { method: 'HEAD' });
    appendConsole(`CDN response status: ${r.status} ${r.statusText}`);
    info.push('CDN reachable: ' + (r.ok ? 'OK' : `${r.status} ${r.statusText}`));
  } catch (err) {
    appendConsole('CDN fetch error: ' + (err.message || err));
    info.push('Gagal menghubungi CDN: ' + (err.message || err));
  }
  info.push('');
  info.push('Saran:');
  info.push('- Jika muncul error CORS/Failed to fetch: jalankan server lokal (Termux) atau gunakan PC.');
  info.push('- Jika muncul Unknown encoder / could not find codec: build ffmpeg.wasm tidak menyertakan encoder (pakai Termux native ffmpeg).');
  diagArea.innerText = info.join('\\n');
}

document.getElementById('btnLoad').addEventListener('click', async () => {
  appendConsole('Load FFmpeg ditekan — memulai load ...');
  try {
    if (!ffmpeg.isLoaded()) {
      await ffmpeg.load();
      appendConsole('ffmpeg.wasm berhasil dimuat.');
      alert('ffmpeg.wasm berhasil dimuat. Tekan Proses untuk menjalankan.');
    } else {
      appendConsole('ffmpeg sudah dimuat.');
      alert('ffmpeg sudah dimuat.');
    }
  } catch (e) {
    console.error('Gagal load ffmpeg.wasm:', e);
    appendConsole('ERROR saat load: ' + (e && e.message ? e.message : String(e)));
    alert('Gagal memuat ffmpeg.wasm — lihat log.');
  }
});

document.getElementById('btnRun').addEventListener('click', async () => {
  const f = document.getElementById('file').files[0];
  if (!f) { appendConsole('Tidak ada file dipilih — abort'); alert('Pilih file terlebih dahulu'); return; }
  appendConsole('Proses dimulai: ' + f.name);
  try {
    if (!ffmpeg.isLoaded()) {
      appendConsole('ffmpeg belum dimuat — mencoba load otomatis...');
      try { await ffmpeg.load(); appendConsole('ffmpeg auto-load OK'); } 
      catch(e){ console.error('Auto-load gagal:', e); alert('Gagal load ffmpeg, lihat log'); return; }
    }
    const inName = 'input_debug.mp4';
    const outName = 'out_debug_1080x1920.mp4';
    appendConsole('Menulis file ke FS (memory)...');
    const data = await fetchFile(f);
    ffmpeg.FS('writeFile', inName, data);
    appendConsole('Menjalankan ffmpeg (filter/crop/vstack)...');
    const filter = "[0:v]scale=1080:-1,pad=1080:1920:0:(1920-ih)/2,crop=1080:960:0:0[top];" +
                   "[0:v]scale=1080:-1,pad=1080:1920:0:(1920-ih)/2,crop=1080:960:0:960[bottom];" +
                   "[top][bottom]vstack=2[out]";
    const args = ["-i", inName, "-filter_complex", filter, "-map", "[out]", "-map", "0:a?", "-c:v", "libx264", "-preset", "veryfast", "-crf", "23", "-c:a", "aac", "-b:a", "128k", outName];
    appendConsole('Args: ' + args.join(' '));
    try {
      await ffmpeg.run(...args);
      appendConsole('ffmpeg selesai tanpa error.');
      const result = ffmpeg.FS('readFile', outName);
      appendConsole('Output size: ' + result.length + ' bytes');
      const url = URL.createObjectURL(new Blob([result.buffer], { type: 'video/mp4' }));
      const a = document.createElement('a'); a.href = url; a.download = outName; a.textContent = 'Download result: ' + outName;
      a.style.display = 'block'; a.style.marginTop='8px';
      consoleLog.appendChild(a);
      appendConsole('Selesai: file siap diunduh (lihat di log).');
      alert('Selesai: hasil siap diunduh (lihat link di log).');
    } catch (e) {
      console.error('ffmpeg.run error:', e);
      appendConsole('ffmpeg.run error: ' + (e && e.message ? e.message : String(e)), 'error');
      alert('ffmpeg.run mengeluarkan error — lihat log.');
    } finally {
      try { ffmpeg.FS('unlink', inName); } catch(e){}
      try { ffmpeg.FS('unlink', outName); } catch(e){}
    }
  } catch (e) {
    console.error('Error proses:', e);
    appendConsole('Error proses: ' + (e && e.message ? e.message : String(e)), 'error');
    alert('Error: lihat log.');
  }
});

document.getElementById('btnDiag').addEventListener('click', runDiagnostics);
document.getElementById('btnClear').addEventListener('click', () => { consoleLog.innerText=''; ffLog.innerText=''; appendConsole('Log dibersihkan'); });

appendConsole('Debug page siap. Tekan Load FFmpeg lalu Proses.');
</script>
</body>
</html>
